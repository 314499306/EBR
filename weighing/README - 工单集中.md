# 工单集中

---------

## 1、 业务功能描述
- “集中”操作在“称量”操作后或“混合”操作前对一个工单的流转准备工作进行验证。
- 操作方法是选择符合的工单在库房或工作车间对所有的预期筹备工作进行检查, 通过标签识别。
- “集中”生命周期如下图所示：![图片](/pics/工单_集中生命周期.png)
- “集中”操作流程图如下所示： ![图片](/pics/集中-流程图.png)

## 2、 需求描述
集中功能主要分2部分：1.MI配置中的工艺实例；2.工单执行中的集中操作。

### 2.1 工艺实例
- 在 MI配置->工艺实例->集中 设置规划需要集中的物料。参考图如下所示:
![图片](/pics/集中-MI配置参数.png)
  - 配置规则：  
    1. 指定开始阶段、次序、剂量和结束阶段、次序、剂量。  
      举例1：如果从阶段 0001 次序 0001 剂量 1--->阶段 0003 次序 0003 剂量 1；  
      举例2：如果只是指定了阶段 0001--->0002,将集中 0001,0002 阶段的所有序列和剂量。  
    2. 配置集中模式，选择集中模式是“称量后”或“混合前”（集中操作界面不同）。  
    3. 阶段、次序、剂量 参数从处方信息中选择，功能同“工艺实例-称量”

### 2.2 集中操作
#### 2.2.1 工单称重集中
##### 2.2.1.1 界面
- 布局，如下图所示：![图片](/pics/集中-称重集中布局.png)
  1. 工单信息展示区：展示当前工单的详细信息，以便客户查看。
  2. 称重信息及集中状态展示区；所有信息同步称重信息；[集中状态]随着集中操作结果返回值而同步更新。
  3. 集中工序操作区：实现集中操作工序的信息录入与触发。
- 称重信息及集中状态展示区需求描述：
  - 深色字体数据行：表示需要进行“集中”操作。
  - 浅色字体数据行：表示 1）不可称重的物料，因此不可集中；2）可称重但不可集中物料；3）已经集中的物料。 

##### 2.2.1.2 集中操作
- 启动路径：  
  1. MI执行，同“称重”工序功能块。
  2. 工单管理，“集中”按钮。
- 操作步骤：  
  1. 集中启动：1）在MI执行界面，“称重”工序完成后“集中”工序；2）在工单管理界面，选中某条工单，如工序流转到“集中”工序，则“集中”按钮被激活，否则不被激活。
  2. 信息录入：![图片](/pics/集中-称重集中操作.png)支持扫码录入和人工录入。
  3. 确认校验（签名）：自动校验“容器标识号/称量标签”是否正确。如果正确则改变“集中状态”为“已集中”，**`注意：对于带标签的物料集中过程中，必须全部标签项完成集中操作，该物料集中状态才能变更为“已集中”`** ![图片](/pics/集中-带标签集中状态.png)。如果不正确弹出错误/警告提示。
    - 集中状态：集中状态枚举为：待集中；锁定；不能集中；已集中。  
    - 状态触发逻辑：工单发布时，如果定义了某物料不可称量，则其集中状态为N（不可集中）；若该物料可称量，则物料的初始集中状态为B。对于可称量的物料，在执行称量操作后，实际称量数据的集中初始状态为A（可集中）；若在工作流中执行到了集中节点，且该料在节点中属于配置的范围内，则该料的集中状态变为A（不在集中节点配置范围内物料集中状态依然为B），实际称量数据依然为A，当对实际称量数据执行集中操作后，该条数据的集中状态变为R（已集中），当该料的所有实际称量数据的集中状态都为R时，该料的集中状态才变为R。
    - 错误/警告/提示分类：  
      1）【无效的称量标识】：判断条码规则（如长度、组成规则、有效性等）；  
      2）【称量标识不在集中任务中】：判断条码与所选工单数据不匹配；  
      3）【此称量标识已经进行了集中】：判断已完成集中操作的标识再进行重复集中操作；  
      4）【此物料不能进行集中操作】：判断不能进行集中操作的物料进行集中操作；  
      5）【此称量标识完成了集中】：
  4. 确认签名：同“称重”确认签名。
  5. 完成流转：工单中所有待集中任务都完成后“集中”工序结束。
  6. 数据更新：
    - 集中状态
    - 集中操作员
    - 集中工作站
    - 集中操作日期时间

##### 2.2.1.3 重新打印标签
- 在“集中”操作过程中可随时进行“重新打印标签”操作。分为“称重标签”、“托盘标签”、
![图片](/pics/集中-标签重新打印main.png)
- 称重标签：功能同“称重”模块中的标签打印；
- 托盘标签：功能同“称重”模块中的标签打印；
<!--
- 重新分配托盘：功能同“称重”模块中的标签打印。  
重新分配托盘允许通过增加或减少托盘数量重新分配离开配药间的托盘。还允许通过指定这些标签上的托盘总数来再次打印托盘标签。
![图片](/pics/集中-标签重新打印-托盘重新分配.png)  
--> 



>#### 2.2.2 工单混合集中
>设计暂未完成

- 混合介绍：制造工单时，组合可以对应：
来自药房的称重标签的组合，以及
可能是仓库容器的组合，例如，来自中间生产申报。
此操作可以从“复合”可执行程序、射频或工作流的组合元素执行。

- 混合前集中介绍：制造调节允许在组合之前控制给定WO的所有称重标签。 该操作可以从“复合”可执行程序，无线电频率或工作流程的协调元素执行


##### 2.2.2.1 界面
- 布局，如下图所示：![图片](/pics/集中-混合集中布局.png)
  1. 工单信息展示区：展示当前工单的详细信息，以便客户查看。
  2. 称重信息及集中状态展示区；所有信息同步称重信息；[集中状态]随着集中操作结果返回值而同步更新。
  3. 集中工序操作区：实现集中操作工序的信息录入与触发。
- 称重信息及集中状态展示区需求描述：
  - 深色字体数据行：表示需要进行“集中”操作。
  - 浅色字体数据行：表示 1）不可进行“集中”操作；2）已经集中的物料。 
- 显示字段：
  - 工单信息：字段：[工单号];[版本];[批次];[产品描述];[操作员];[工作中心];[优先级];[发布日期];[ERP下发时间];[数量];[状态]。
  - 集中信息：字段：[阶段];[次序];[剂量];[物料编码];[物料描述];[数量];[单位];[容器标识号/称量标签];[集中状态]。

##### 2.2.2.2 集中操作
- 启动路径：  
  1. MI执行，同“称重”工序功能块。
  2. 工单管理，“集中”按钮。
- 操作步骤：  
  1. 集中启动：1）在MI执行界面，“混合”工序开始前“集中”工序；2）在工单管理界面，选中某条工单，如工序流转到“集中”工序，则“集中”按钮被激活，否则不被激活。
  2. 信息录入：![图片](/pics/集中-混合集中操作.png)支持扫码录入和人工录入。
  3. 确认校验（签名）：自动校验“容器标识号/称量标签”是否正确。如果正确则改变“集中状态”为“已集中”。如果不正确弹出错误/警告提示。
    - 集中状态：集中状态枚举为：待集中；锁定；不能集中；已集中。  
    - 状态触发逻辑：工单发布时，如果定义了某物料不可称量，则其集中状态为N（不可集中）；若该物料可称量，则物料的初始集中状态为B。对于可称量的物料，在执行称量操作后，实际称量数据的集中初始状态为A（可集中）；若在工作流中执行到了集中节点，且该料在节点中属于配置的范围内，则该料的集中状态变为A（不在集中节点配置范围内物料集中状态依然为B），实际称量数据依然为A，当对实际称量数据执行集中操作后，该条数据的集中状态变为R（已集中），当该料的所有实际称量数据的集中状态都为R时，该料的集中状态才变为R。
    - 错误/警告/提示分类：  
      1）【无效的称量标识】：判断条码规则（如长度、组成规则、有效性等）；  
      2）【称量标识不在集中任务中】：判断条码与所选工单数据不匹配；  
      3）【此称量标识已经进行了集中】：判断已完成集中操作的标识再进行重复集中操作；  
      4）【此物料不能进行集中操作】：判断不能进行集中操作的物料进行集中操作；  
      5）【此称量标识完成了集中】：
  4. 确认签名：同“称重”确认签名。
  5. 完成流转：工单中所有待集中任务都完成后“集中”工序结束。
  6. 数据更新：
    - 集中状态
    - 集中操作员
    - 集中工作站
    - 集中操作日期时间


```
