# 混合（配料）

---------

## 1、 业务功能描述
- “混合（配料）”操作是识别、控制和跟踪用户混合工序的物料及目标设备。
- 操作方法是选择符合的工单在“混合前集中”操作工序完成的前提下进行“混合”工序操作，操作内容包括：
  1. 称量标签鉴定；
  2. 混合设备鉴定(根据配置)；
  3. 配料顺序（根据配置）。
通过标签对需要混合的物料和混合的目标设备(根据配置)进行识别（特定条件下进行优先级控制）。
- “集中”操作流程图如下所示： ![图片](/pics/集中-混合流程图.png)

## 2、 需求描述
集中功能主要分2部分：1.MI配置中的工艺实例；2.工单执行中的混合操作界面。

### 2.1 工艺实例
- 在 MI配置->工艺实例->混合 设置规划“混合”工序需要的配方物料（阶段/次序/剂量）、目标设备、混合模式等规程参数。参考图如下所示:
![图片](/pics/集中-混合MI配置参数.png)
  - 配置规则：  
    1. 指定开始阶段、次序、剂量和结束阶段、次序、剂量。  
      举例1：如果从阶段 0001 次序 0001 剂量 1--->阶段 0003 次序 0003 剂量 1；  
      举例2：如果只是指定了阶段 0001--->0002,将集中 0001,0002 阶段的所有序列和剂量。  
    2. 配置混合（配料）模式，包含三种模式：
      - 无约束与排序：混合（配料）无顺序约束要求；
      - 剂量约束排序：按剂量约束，某一相同剂量的物料必须完成混合（配料）操作后才能进行下一剂量物料的混合（配料）操作；
      - 阶段/剂量/次序约束排序：要求按照阶段>剂量>次序的约束优先级进行混合（配料）操作  
    三种模式逻辑如下图所示：
    ![图片](/pics/集中-混合模式逻辑图.png)
    3. 配置目标设备校验功能：
      - 配置是否启动目标设备校验功能，选择框勾选为启动，不勾选为不启动。如不启用下拉框不可用且为空，“配置”按钮不可见![图片](/pics/集中-混合-目标设备不启动.png)；如启动则下拉框可用且可选“MI文本”和“设备标识码”两种方式，“配置”按钮在选中“设备标识码”方式时可见，其他情况不可见![图片](/pics/集中-混合-目标设备启动.png)。
      - 目标设备校验信息通过两种方式获取，一、设备标识码：通过设备管理模块直接选择规划混合工序的设备及其标识码；二、MI文本：根据现场实际情况二次开发MI文本动态设定混合工序的设备及其标识码。

### 2.2 混合（配料）操作
#### 2.2.1 界面
- 布局，如下图所示：![图片](/pics/集中-混合布局.png)
  1. 工单信息展示区：展示当前工单的详细信息，以便客户查看。
  2. 混合数据信息展示区；所有信息同步混合前集中信息；[混合状态]随着混合操作结果返回值而同步更新。
  3. 混合工序操作区：实现混合操作工序的信息录入与校验。
- 混合数据信息展示区需求描述：
  1. 深色字体数据行：表示需要进行“混合”操作。
  2. 浅色字体数据行：表示 1）不可混合物料；2）已经混合的物料。 
- 数据排序：MI配置混合（配料）模式设置为“阶段/剂量/次序约束排序”时，数据的排序优先级为：阶段>剂量>次序>标签。

#### 2.2.2 混合操作
- 启动路径：  
  1. MI执行，同“称重”工序功能块。
  2. 工单管理，“混合”按钮。
- 操作步骤：  
  1. 混合启动：  
    1）在MI执行界面，“混合前集中”工序完成后“混合”工序启动 **`（注意：定义流程时“混合”工序前的必要充分条件是“混合前集中”工序）`**；  
    2）在工单管理界面，选中某条工单，如工序流转到“混合”工序，则“混合”按钮被激活，否则不被激活。如工序没有流转到“混合”工序则界面内数据为空，且录入框及按钮不被激活。
  2. 信息录入：![图片](/pics/集中-混合操作.png)
    - 所有录入框都可实现扫码录入和人工录入。
    - 如MI配置中选择了启动目标设备校验功能，则“目标设备设备号”录入框和“确认按钮”可见或激活，否则不可见或不激活。并且在目标设备校验通过之前“称重标签”录入框不被激活，只有目标设备校验通过后“称重标签”才被激活。
    - 如MI配置中没有选择启动目标设备校验功能，则则“目标设备设备号”录入框和“确认按钮”不可见或不被激活。并且“称重标签”录入框可操作。
    
  3. 确认校验（签名）：  
    - 目标设备识别号校验：根据MI配置，校验“MI文本”设置的参数值或校验MI预置好的参数值。如果正确则开始校验“容器标识号/称量标签”，如果不正确则弹出提示。 
    - “容器标识号/称量标签”校验：自动校验“容器标识号/称量标签”是否正确。如果正确则改变“混合状态”为“已混合”，如果不正确弹出错误/警告提示。
    - 混合状态：集中状态枚举为：待混合；锁定；不能混合；已混合；已退料取消称量。  
    - 状态触发逻辑：  
    初始状态：“混合前集中”工序结束后，集中状态为R（已集中）的物料称量数据混合状态为A（待混合）；集中状态为B（锁定）的物料称量数据混合状态为B（锁定）；集中状态为N（不能集中）的物料称量数据混合状态为N（不能混合）。  
    “混合”操作后状态：通过“混合确认签名”后数据的混合状态由A（待混合）更新为R（已混合）。
    - “目标设备”错误/警告/提示分类：  
      1）【无效的目标设备标识】：判断条码规则（如长度、组成规则、有效性等）；  
      2）【目标设备标识不匹配】：判断条码与设置的目标设备标识码数据不匹配；  
      3）【目标设备标识已确认】：  
    - “称量标识”错误/警告/提示分类：  
      1）【无效的称量标识】：判断条码规则（如长度、组成规则、有效性等）；  
      2）【称量标识不在混合任务中】：判断条码与所选工单数据不匹配；  
      3）【此称量标识已经进行了混合】：判断已完成混合操作的标识再进行重复混合操作；  
      4）【此物料不能进行混合操作】：判断不能进行混合操作的物料进行混合操作；  
      5）【此称量标识完成了集中】：
  4. 确认签名：同“称重”确认签名。
  5. 完成流转：工单中所有待混合任务都完成后“混合”工序结束。
  6. 数据更新：
    - 混合状态
    - 混合操作员
    - 混合工作站
    - 混合操作日期时间




```
