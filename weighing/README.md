# 称量

## 1. 衡器基础配置

- 衡器配置:![pic](/pics/称量_衡器配置.jpg)

  - 当配置衡器时"使用证书"复选框选中时,后面的警告天数的输入框才可以输入,天数范围为 0-999;只有勾选了该项后,才可在输入证书 ID 及有效期.
  - 类型引用自衡器类型表,衡器类型表里定义了衡器类型的简写,对应的版本和相应的最大秤台数,当衡器类型对应的版本为"2"时,衡器通信设置里的 DLL 参数设置才会显示.
  - 天平范围对应的是衡器精度表,范围最少一个,最多三个,首行的最小范围等于最小容量,尾行的最大范围等于最大容量,且相邻行的下一行的最小范围等于上一行最大围;偏差表示衡器的误差范围,校准公差表示校准称量时所能接受的误差范围.
  - 设备包括"天平"和"地磅"两种,与校准配置有关联.
  - com 口的范围为 0-99,不同的秤 com 口不能重复;"台"表示秤台编号,同一个秤可能连接多个秤台,此时可以共用同一个 com 口.
  - ~~衡器添加在外设设备中添加,要求一个衡器值只能绑定一个工作站.~~
  - 衡器的新增与状态变更在"外设设备"处进行,新增的衡器为"注册"状态,然后用户可以手动切换为"在线"或"离线",注册,在线或离线状态时,称量模块才可进行衡器置且只有在"在线"状态时衡器才可以进行称量.

  - 衡器做修改后，所有的校准状态均取消.

## 2. 衡器校准

### 2.1 校准设置

- 校准设置:![pic](/pics/称量_校准类型设置.jpg)
- 校准周期:![pic](/pics/称量_校准周期.jpg)
  - 校准设置作用于所有的称量站,可对不同的衡器类型进行分别设置.
  - 称重数表示对该种校准类型需要称量几次来进行校准.
  - 多范围校准表示是否对衡器设置的不同精度范围均进行校准,每个范围的校准称重次数与称重数一致.
  - 不同称量表示在多次称重数下,每次称量选择要求的校准砝码不一样.
  - 校准级别最多分三级,且较大级别的校准类型应该大于较小级别的,即较小级别的校准频率应该高于较大级别的,如:Type1 设置的校准类型为"每三个月的",则 Type2 设置校准类型只能为""每半年的"或"每年的".
  - 设置的校准类型都校准后才算校准生效,且若设置了衡器包含证书,则只有衡器校准和证书均在有效期内,衡器才可用于称量.
  - 当校准设置更新时,之前的已经完成的校准均作废.

### 2.2 校准页面

- 校准页面:![pic](/pics/称量_校准页面.jpg)
- 只有未校准的衡器才可以进行校准称量操作.执行的校准称量记录到校准历史表中.校准时只会弹出提示框,提示是否清洁秤台,而不会弹出已设置的清洁提示确认页面.
- 【F6:取消】:F6 表示快捷键,此按钮表示取消当前衡器的有效校准状态,并将有效期重置至预定义的初始有效期,如"01-01-1990".
- 【?F1】:查看"校准设置"页面.
- 【退出】:返回上一级页面.
- 校准信息:校准信息的内容显示主要取决于"校准类型"的选择,即选择了校准类型后,校准信息表才可能会显示与该校准类型相关的所有校准操作记录,而是否显示主要与有效期的结束日期相关.在选择校准类型后,若"校准有效期的结束日期"大于当前时间,则校准信息列表不显示任何信息;若小于当前时间,则会显示自上次该校准类型的校准有效期过期时（有效期由大于等于当前时间变为小于当前时间）的所有称量校准操作记录.如:某一校准类型的有效期为前天,则校准信息列表会显示自昨天开始到下一次完成该校准类型校准的所有称量校准操作;假设此刻完成了校准,则校准信息表不再显示内容,而在此之前,则能显示自昨天开始的所有称量校准操作.

### 2.3 校准操作

- 因进度要求,现阶段保留"校准类型",【取消】,【验证】三项,在进行校准操作时,需选择"校准类型",然后单击【验证】即可进行完成校准,校准的有效期根据所选校准类型自动换算得出.此外,只有不在有效期内的衡器才可进行校准;衡器仍在有效期内且想进行校准操作的,可先单击【取消】,使有效期重置,然后便可进行校准操作.
- 若衡器处于未校准状态,选择衡器后,单击【校准】则在校准计划表根据校准设置生成校准计划,如地磅类型校准设置为"每周","每月"两个级别,则在校准计划表生成两行;每一级都有对应的计划校准次数（校准设置里计算得出）和实际校准成功的次数,只有在两者相等时,该层级的校准状态变为"true",且有效期结束日期以最后一次校准的时间来计算得出,当所有层级的校准状态变为"true",则衡器信息表里的校准状态会变成 true;当校准有效期过期或主动取消时,对应层级的校准状态变为"false",校准有效期重置为一个初始值.若校准设置做了变动,则删除校准计划表中对应衡器类型的所有数据.

## 3. 称量工站清洁

- 称量工站清洁设置:![pic](/pics/称量_WDU清洁设置.jpg)
- 厂区表示清洁提示作用的区域范围.清洁类型表示编辑的内容是按工单还是按物料进行提示.编辑时可定义规则编码和规则名称,规则名称填写具体要提示确认的内容.

## 4. 称量

### 4.1 进入称量
- 称量工单页面默认显示待称量的工单，系统后台会依据以下条件进行判定是否为可称量的工单:
  - 工单发布时配置的工作中心与当前工站的工作中心匹配
  - 工单状态:已发布或生产中
  - 物料均为已验证状态
  - 工单物料有待称量的物料,即工单称量没有全部完成
  - 配有 MI 的工单:
    - MI 模块有称量模块，有才可进行称量;
    - 工作中心是否与 MI 里定义的物料称量工作中心相符
    - MI 是否已经执行到该称量节点，即在称量节点在 MI 中是否可执行

### 4.2 称量模式

- 称量模式:![pic](/pics/称量_称量模式.jpg)
- 物料默认的称量模式为工单发布时定义的,且只有在配置物料时定义了该种称量模式可用时,在称量时才可选.当切换称量模式时,系统会与默认的称量模式做比较,若不是默认的,则会进行提示.

### 4.3 误差提示

- 误差提示:![pic](/pics/称量_误差提示.jpg)
- 如果实际称量单位与衡器单位不一致，则无需提示，且称量模式为手动等也无需提示.
- 允许误差来自于发布工单时定义的物料的"偏差",默认为千分之三,计算公式为即将称重量乘以偏差;天平误差来自于衡器的精度范围里定义的偏差.当衡器定义的最小偏差大于允许误差,则显示图中提示.
- 误差提示在第一次点击验证时出现,此时会将衡器设置的偏差与工单发布的允许误差进行比较,若衡器的偏差大于允许误差,则出现如图提示(其中,"天平"改为"衡器");此外,衡器的偏差可能根据范围的不同有多种,此时需要根据实际待称量的量来确定,即实际待称量量在哪个范围内,则选中的是对应的衡器偏差.

### 4.4 批次提示

- 批次提示:![pic](/pics/称量_批次提示.jpg)
- 输入容器标识号可获取待称量物料的批次信息,当该批次物料是在此工单发布前接收的,则有该提示;如果是在工单发布后接收的,则无提示.

### 4.5 数量不足提示

- 数量不足:![pic](/pics/称量_数量不足.jpg)
- 当选择的容器剩余的物料量小于等于 0 时,则报该提示.

### 4.6 终止容器提示

- 终止容器提示:![pic](/pics/称量_终止容器提示.jpg)
- 若选择的容器是终止容器,则会显示该提示.
- 终止容器:![pic](/pics/称量_终止容器.jpg)
- 称量完成后,会有该提示,若选择"是",则将该容器变为终止状态.

### 4.7 模式称量

#### 4.7.1 净重称量

- 净重:![pic](/pics/称量_净重.jpg)
- 净重称量操作流程:![pic](/pics/称量_净重称量.png)
- 净重称量结束后选择:![pic](/pics/称量_净重称量完成选择.png)
- 此称量模式需要用户输入皮重,然后称量获取净重,毛重=净重+皮重.当物料单位为 L/mL 等时,密度参与换算,由公式 m=ρ•V 可得出需要称量的总重量,其余步骤与重量单位的称量方式一致.
- 称量完成后,点击【标签】按钮时,后台校验容器中可称量的物料量是否大于或等于称量的物料量,否则提示"该容器库存量不足！".
- 选择【同一容器】后,若选择的称量物料的批次与上一次的不同,则提示"不同批次的物料！".
- 【剩余量】显示的是理论剩余待称量量/理论总待称量量,理论待称量量与实际待称量量之间遵循公式(理论量 × 理论效价=实际量 × 实际效价),即剩余待称量量=理论总待称量量-(实际称量量 × 实际效价)/理论效价.如:理论总待称量量为 10kg,理论效价为 50%,假设实际称量量为 4kg.实际效价为 100%,则理论剩余待称量量=10-(4×100%)/50%=2kg;假设物料还未开始称量,实际效价为 40%,则实际需要称量的量=(10×50%)/40%=12.5kg.
- 【总重量】显示的是每次实际称量的净重总和.
- 选择【标签】后,完成称量,并打印称量标签;选择【相同容器】后,则如操作流程图所示继续称量,需输入皮重,且皮重值需等于上次称量后的毛重值;选择【取消】后,取消本次称量.

#### 4.7.2 毛重称量

- 毛重:![pic](/pics/称量_毛重.jpg)
- 毛重称量操作流程:![pic](/pics/称量_毛重称量.png)
- 毛重称量结束后选择:![pic](/pics/称量_毛重称量完成选择.png)
- 此称量模式需要用户输入皮重,然后称量获取毛重,净重=毛重-皮重.当物料单位为 L/mL 等时,密度参与换算.
- 选择【标签】后,完成称量,并打印称量标签;选择【连续毛重】后,皮重不可输入,延用上次的皮重;选择【取消】后,取消本次称量.

#### 4.7.3 手动称量

- 手动:![pic](/pics/称量_手动.png)
- 手动称量操作流程:![pic](/pics/称量_手动称量.png)
- 此称量模式需要用户直接输入净重,当物料单位为 L/mL 等时,密度参与换算.

#### 4.7.3 混合称量

- 混合称量:![pic](/pics/称量_混合称量操作.png)
- 混合称量原理图: ![pic](/pics/称量_混合称量原理图.png) ![pic](/pics/称量_混合称量原理图2.png)
- 在同一容器中的相同工单中称量物料,一个容器称量完一种物料后,将此时的毛重作为皮重,继续添加称量第二种物料,依次类推
- 在第一次称量完成后,若选择继续混合称量,则在接下来的输入皮重环节会校验皮重是否与上一次称量毛重一致,若不一致,则提示"皮重与上一次毛重不符,称量取消".
- 在混合称量模式下,效价与密度等的换算遵循现有的规则
- 参考 UI 如下
  - ![pic](/pics/称量_混合称量参考UI.png) ![pic](/pics/称量_混合称量参考UI2.png)

### 4.8 清洁提示

- 清洁提示:![pic](/pics/称量_WDU清洁提示.jpg)
- 清洁提示分两种,一种是按工单提示,另一种是按物料提示.按工单提示是在一个新的称量工单开始时会进行提示;按物料提示是在同一工单下切换不同物料称量时才提示.按工单提示是在开始新的工单称量时出现,按物料提示是在同一工单下称量不同物料时才出现,两种提示不能同时出现,出现后用户需签名确认.

### 4.9 详细工单

- 详细工单:![pic](/pics/称量_详细工单.jpg)
- 配方:![pic](/pics/称量_配方.png)
- 称量工单用于指导和记录称量操作,在工单发布时自动生成,其中记录两种类型的数据,一种是理论称量清单,另一种是实际称量数据.理论称量清单是在发布工单时自动生成的,字体为黑色的是在对应的工作流中定义了相应的称量模块,是可称量的;而字体为浅灰色的是未定义相应的称量模块,是不可称量的.此外,实际称量数据记录的是对应物料的称量记录,"U/标签"在理论称量清单中显示的是物料单位,而在实际称量数据记录中显示的是称量次序编码,是由 WeighHistory 基础表中的 weighIndex 字段决定的,格式为""###",如在数据库中为 1,则在此处显示为"001".
- "剩余/实际":当数据属于理论称量清单时,此处显示的是剩余需要称量的理论量;当属于实际称量数据时,此处显示的实际称量量.
- "WU":当为理论清单时,不显示;当为实际称量数据时,显示称量单位.
- "P":当为理论清单时,可能值为 T(称量完成),N(不可称量),W(待称量),P(称量中),其中,T 表示该物料已按要求称量完成,N 表示不可称量（主要在配置物料时定义）,P 表示该物料已开始称量且未终止;当为实际称量数据时,可能值则为实际称量所使用的称量模式.
- "R":当为理论清单时,可能值为 A(待集中),R(已集中),N(不可集中),B(正在集中),其中,N 是因为在配置物料时定义了不可称量;当为实际称量数据时,可能值为 A(可集中),R(已集中),N(不可集中).
- 【强制称量】:选中可称量的理论称量物料,单击此按钮,用户签名认证,即可强制完成称量;若选中的是不可称量的物料,则提示"该生产物料状态为 T,不可进行强制称量！".
- 【配方】:单击此按钮可查看配方详情,如上图.

### 4.10 皮重,毛重提示

- 输入的皮重需要大于衡器的称量范围下限且小于衡器的称量范围上限,否则提示"皮重<衡器称量下限"或"皮重>衡器称量范围上限".
- 称量的净重必须大于 0,且毛重应大于皮重,否则提示"毛重小于皮重:称量失败！".

### 4.11 自动推荐衡器

- 当选择工单进入称量页面后,系统默认选择可称量物料中阶段/次序最小的（如"0001 0001"）.系统推荐的衡器主要基于两点:1,称量单位,系统会根据物料的称量单位自动匹配合适的衡器;2,衡器称量上限,若多个衡器有相同的称量单位,则系统根据衡器称量上限进行排序,然后选择该范围内最小称量上限的衡器.

### 4.12 危险防范提示

- 危险防范:![pic](/pics/称量_危险防范.png)
- 称量开始单击【验证】时,在确认其余提示后弹出此页面,点击【确认】进入称量状态,点击【取消】返回之前的未开始称量状态.

### 4.13 自动折算/单位换算

- 当效价 1 类型为 N 时,库存单位可为 mg/g/kg/ml/L/un/un/kn/fl.
- 当效价 1 类型为 P（Potency）/L（ug/mg）时,库存单位必须为 mg,g,kg,ml 或 l.
- 当效价 1 类型为 S（mg/ml）/R(ug/ml)时,库存单位必须为 mg,g,kg.
- 当效价 1 类型为 U（IU/mg）,M（MIU/g）,V（IU/g）,T（IU/ml）时,库存单位必须为 ui,ku,gu,mu.
- 以下密度均为批次密度.衡器的精度保持在小数点后三位,当计算出的实际待称量的值小于 0.001,则显示的待称量量为 0.
- 当称量模式为"激光"时,实际待称量量=理论剩余量（当实际和理论相等时,单位也保持一致）,称量单位沿用物料单位.
- 参与换算的主要包括物料效价（理论效价,物料模块定义）,批次效价（实际效价,批次接收时定义）以及批次密度.1ug=10^-6g,即 1g 等于 1 百万 ug.
- 总重量的单位与物料第一次称量的称量单位保持一致,若第二次称量时的称量单位与第一次之间无直接换算关系（如 ml 与 g）,则无法进行称量,系统提示"请选择指定的称量模式进行称量！";如第一次称量完成后修改了被称物料的属性（如效价,密度等）.
- 同一物料多次称量时,称量单位保持一致,若是"净重"等需输入皮重的称量模式时,净重,毛重,皮重等单位与称量单位保持一致.

| X< Q < Y                   | 称量单位 |
| -------------------------- | -------- |
| Q <10 g                    | mg       |
| 10 g < Q < 10 kg           | g        |
| Q >= 10 kg                 | kg       |
| Q < 10 l                   | ml       |
| Q >= 10 l                  | l        |
| Q < 10 000 iu              | iu       |
| 10 000 iu <= Q < 10 000 ku | ku       |
| 10 000 ku <= Q < 10 000 mu | mu       |
| Q >= 10 000 mu             | gu       |
| Q <= 10 000 un             | un       |
| Q > 10 000 un              | kn       |
| Q < 1 kn                   | un       |
| Q >= 1 kn                  | kn       |
| Q ( fl)                    | fl       |

- 效价类型为 N,效价不参与换算;单位为 un,kn,lb,kg,g,mg 时,实际待称量=理论剩余量;单位为 ml,L 时,"净重"等需输入皮重的称量模式时,实际待称量量=理论剩余量 × 批次密度,使用密度时密度取批次密度,不使用密度时密度值默认为 1,"手动"等称量模式下,实际待称量量=理论剩余量.
- 处方使用效价时,若待称物料单位为 kg:效价类型为 L（ug/mg）,P（百分比）时,实际待称量=理论剩余量 × 物料效价/批次效价;若效价类型为 R(ug/ml),S（mg/ml）时,只能选择"手动"等称量模式,实际待称量量=理论剩余量/批次效价.
- 处方使用效价时,若待称物料单位为 g/mg:使用密度时,效价类型为 L（ug/mg）,P（百分比）时,实际待称量=理论剩余量 × 物料效价/批次效价;效价类型为 R(ug/ml)时,"手动"等称量模式下,实际待称量=理论剩余量 × 物料效价/批次效价,"净重"等需输入皮重的称量模式时,实际待称量量=理论剩余量 × 批次密度/批次效价;效价类型为 S（mg/ml）时,"手动"等称量模式下,实际待称量量=理论剩余量/批次效价,"净重"等需输入皮重的称量模式时,实际待称量量=理论剩余量 × 批次密度/批次效价.不使用密度时,效价类型为 R(ug/ml),S（mg/ml）时,称量模式只可选"手动","强制"等,实际待称量量=理论剩余量/批次效价,且效价类型为 R(ug/ml)时称量单位为 ml;效价类型为 L（ug/mg）,P（百分比）时,实际待称量=理论剩余量 × 物料效价/批次效价.
- 处方不使用效价时,若待称物料单位为 kg:使用密度时,效价类型为 L（ug/mg）,P（百分比）时,实际待称量=理论剩余量.效价类型为 R(ug/ml),S（mg/ml）时,"手动"等称量模式下,实际待称量量=理论剩余量;"净重"等需输入皮重的称量模式时,实际待称量=理论剩余量 ×1000,称量单位为 ml.不使用密度时,效价类型为 R(ug/ml),S（mg/ml）时,称量模式只可选"手动","强制"等,实际待称量=理论剩余量 ×1000,称量单位为 ml;效价类型为 L（ug/mg）,P（百分比）时,实际待称量=理论剩余量.
- 处方不使用效价时，若待称物料单位为 g,mg:使用密度时，效价类型为 L（ug/mg）,P（百分比）时，实际待称量=理论剩余量，称量单位与原始保持一致（g/mg）.效价类型为 S（mg/ml）,R(ug/ml)时，"手动"称量模式下，实际待称量=理论剩余量/密度，密度为 1g/ml，称量单位为 ml;"净重"等需输入皮重的称量模式时，实际待称量=理论剩余量，称量单位与原始保持一致（g/mg）.不使用密度时，效价类型为 L（ug/mg）,P（百分比）时，实际待称量=理论剩余量;效价类型为 R(ug/ml),S（mg/ml）时，称量模式只可选"手动","强制"等，实际待称量=理论剩余量/密度，密度为 1g/ml，其中称量单位为 ml.
- 处方使用效价时,若待称物料单位为 ml,L:使用密度,"净重"等需输入皮重的称量模式时,实际待称量=理论剩余量 × 物料效价 × 密度/批次效价;"手动"等称量模式下,实际待称量=理论剩余量 × 物料效价/批次效价.不使用密度,"净重"等需输入皮重的称量模式时,实际待称量=理论剩余量 × 物料效价 × 密度/批次效价,其中密度为 1kg/L 或 1g/ml;"手动"等称量模式下,实际待称量=理论剩余量 × 物料效价/批次效价.
- 处方不使用效价时,若待称物料单位为 ml,L:使用密度,"净重"等需输入皮重的称量模式时,实际待称量=理论剩余量 × 批次密度;"手动"等称量模式下,实际待称量=理论剩余量.不使用密度,"净重"等需输入皮重的称量模式时,实际待称量=理论剩余量 × 密度,其中密度为 1kg/L 或 1g/ml;"手动"等称量模式下,实际待称量=理论剩余量.
- 待称量物料单位为 lb(磅)时,效价类型为 N,实际待称量=理论剩余量.
- 待称量物料单位为 un(不可称量物料单位或者技术称量模式单位)时,可选择的称量模式为"计数称量","手动","强制","激光"等,当为计数称量时,实际待称量=（理论总称量量-已称量的量）× 称量单元,若批次接收时未定义单位重量,则提示"使用计数称量时,批单位重量必须输出！";若为其他称量模式,实际待称量=理论剩余量.
- 待称量物料单位为 kn（上千个单元用于不可称量物料或者可称量模式）时,可选择的称量模式为"手动","强制","激光"等,实际待称量=理论剩余量.
- 待称量物料单位为 fl(为无称量物料或者计数称量模式准备的瓶子)时,可选择的称量模式为"手动","强制称量",实际待称量=理论剩余量.
- 处方不使用效价时,若待称量物料单位为 iu,ku（千倍）,gu（一千万倍）,mu（一百万倍）:使用密度时,若效价类型为 M（MIU/g）,V（IU/g）时,称量模式为"净重"等需输入皮重的称量模式时,实际待称量=理论剩余量/效价单位,称量模式为"手动","强制"等时,实际待称量=理论剩余量;若效价类型为 T（IU/ml）时,称量模式为"净重"等需输入皮重的称量模式时,实际待称量=理论剩余量 × 密度/效价单位（密度取 1g/ml 或 1kg/L）,称量模式为"手动","强制"等时,实际待称量=理论剩余量/效价单位;若效价类型为 U（IU/mg）时,称量模式为"净重"等需输入皮重的称量模式时,实际待称量=理论剩余量 ×1000/效价单位,称量模式为"手动","强制"等时,实际待称量=理论剩余量.不使用密度时,若效价类型为 M（MIU/g）,V（IU/g）时,称量模式为"净重"等需输入皮重的称量模式时,实际待称量=理论剩余量/效价单位,称量模式为"手动","强制"等时,实际待称量=理论剩余量;若效价类型为 U（IU/mg）时,称量模式为"净重"等需输入皮重的称量模式时,实际待称量=理论剩余量 ×1000/效价单位,称量模式为"手动","强制"等时,实际待称量=理论剩余量;若效价类型为 T（IU/ml）时,称量模式只可选"手动","强制"等,实际待称量=理论剩余量/效价单位.
- 处方使用效价时,若待称量物料单位为 iu,ku（千倍）,gu（一千万倍）,mu（一百万倍）:使用密度时,若效价类型为 M（MIU/g）,V（IU/g）,U（IU/mg）时,称量模式为"净重"等需输入皮重的称量模式时,实际待称量=理论剩余量/批次效价,称量模式为"手动","强制"等时,实际待称量=理论剩余量;若效价类型为 T（IU/ml）时,称量模式为"净重"等需输入皮重的称量模式时,实际待称量=理论剩余量 × 批次密度/批次效价,称量模式为"手动","强制"等时,实际待称量=理论剩余量/批次效价.不使用密度时,若效价类型为 M（MIU/g）,V（IU/g）,U（IU/mg）时,称量模式为"净重"等需输入皮重的称量模式时,实际待称量=理论剩余量/批次效价,称量模式为"手动","强制"等时,实际待称量=理论剩余量;若效价类型为 T（IU/ml）时,称量模式只可选"手动","强制"等,实际待称量=理论剩余量/批次效价.
- 总结如下图:
  - 自动折算:![pic](/pics/称量_自动换算1.png) ![pic](/pics/称量_自动换算2.png)

### 4.14 自动称量

- 自动称量:![pic](/pics/称量_自动称量.png)
- 自动称量主要在 MI 文本中的称量标签里设置，需设置接收称量结果的参数.在实际使用过程中，用户需先选择挂在该工作站下的衡器，点击称量标签按钮，后台在称量前自动检查衡器是否复位，如果没有，则建议重置衡器或退出;如果天平已复位，则自动获取衡器上的重量，并显示在图中空白位置，数值稳定后，用户签名验证，即可完成称量，称量完成后，衡器自动重置.
- 自动称量要求只调用称量模块的功能，且称量结果值存储在 MI 模块绑定的参数中，而称量模块并不会产生称量记录，即不会减少线边库的该物料的存储数量.

### 4.15 称量物料复核

- 扫码或快捷键获取容器识别号,单击【验证】,系统自动检测获取的识别号在库存表中是否存在,且容器状态是否符合该工单的批次要求,否则提示"无效的批次"或"该批次的容器状态无效:XX（批次状态）".

### 4.16 界面要求/结果控制

- 进度显示:![pic](/pics/称量_进度显示.png)
- 在进行称量操作时,页面下方的进度条根据上料的重量实时改变,当在实际待称量总重量的 98%之前,颜色为蓝色;当在总重量的 98%~(1-公差)时,显示黄色;当在总重量的(1-公差)~(1+公差)范围内时,显示绿色;当在总重量的(1+公差)之外时,显示红色.同一物料可进行多次称量.
- 超出称量范围:![pic](/pics/称量_超出范围.png)
- 当实际称量量超出总重量时,如图动态条变为红色,此时点击【验证】,系统提示"称量失败,超出称量范围,将取消称量！",点击【确认】~~后弹出取消称量的签名弹框.~~

### 4.17 复核要求

- 结束称量~~和取消称量时~~,需要用户签名认证.

### 4.18 任务控制

- 双击工作流节点中正在进行的称量节点,跳转到称量页面,在进行一系列称量操作后返回工作流界面,系统根据称量结果自动判断是否称量完所有物料,如果已称量完,则当前工作流节点颜色变为已完成的颜色,并连接的下一节点变为正在进行中的颜色;反之,如果未称量完,则原称量节点仍显示正在进行中的颜色.

### 4.19 精度控制

- 称量数据保持小数点后三位,会根据衡器精度表中的衡器精度设置进行显示.

### 4.20 补偿器类型称量

- 补偿器说明:![pic](/pics/称量_补偿器说明.png)
- 效价补偿:![pic](/pics/称量_工单补偿.png)
- 补偿称量:![pic](/pics/称量_补偿称量.png)
- 效价补偿范围:![pic](/pics/称量_效价补偿.png)
- 当发布的工单中,若有效价补偿物料（即补偿器类型为"X"）而无效价补偿物料时,该物料必须最后称量,且该物料的实际称重量会依据有效价的物料的实际称量量和理论量的差值来变化,如上图所示;若不是最后称量,则提示"需称量完原料才可称量补偿物料！".
- 效价补偿说明:效价补偿是针对原料的,处方定义的物料的理论量和补偿器辅料的和是一个定值,在实际称量过程中,原料的实际效价可能较理论效价发生变化,则实际称量量也会改变,效价补偿物料的实际称量量会根据原料的实际称量量发生变化,变化的范围如图所示;如理论的和为 6kg,而实际原料称了 3kg,则效价补偿物料需称 3kg;如果原料实际称量了 8kg,则效价补偿物料无需再称量.效价补偿物料的称量也和普通物料一样,若有偏差则称量时也需考虑,即假使效价补偿物料需称 3kg,偏差为 3‰,则实际称 3\*（1±3‰）都为称量完成.
- QS 说明:![pic](/pics/称量_QS说明.png)
- QS 称量:![pic](/pics/称量_QS.png)
- 工单补偿范围:![pic](/pics/称量_工单补偿1.png)
- 发布的工单中若有工单补偿物料（QS）时,该物料必须最后称量,且只有在（称量当量-工单中所有可称量的物料）>0 时,工单补偿物料才可称量,否则提示"所有物料必须在称量 QS 前称量！";注意,"工单中所有可称量的物料"包括原料和补偿物料,且若工单中该料定义为可称量,但在 MI 模块未定义相应的称量模块,则该 QS 物料无法进行称量,简而言之,只有在发布的工单中定义的所有可称量的物料均已称量完成,工单补偿物料方可进行称量.
- 工单补偿说明:工单补偿是针对可称量的物料,包括原料和辅料;工单发布时有称量当量,实际称量完所有原辅料后,用称量当量减去实际称量量的总和,若结果大于零,则工单补偿物料实际称量量为差值;若结果小于等于零,则工单补偿物料无需称量.
- 效价/工单补偿物料要求均为无效价物料（指处方定义时设置的对应的物料"不使用效价"）.此外,效价补偿物料要求为可称量物料,即单位为 kg/g/mg/lb 等;工单补偿物料无限制（如单位为 mL/L 等）,但实际称量过程中,工单补偿物料的剩余量和单位会根据实际来变化,如处方定义的是 10L,而实际称量时剩余量会显示差值（称量当量-所有可称量量实际总和）,单位为 kg/g/mg 等（依据工单物料称量单位转换规则来定）.

### 4.21 称量完成

- 称量完成公式:![pic](/pics/称量_称量完成公式.png)
- 换算后公式:![pic](/pics/称量_称量完成公式1.png)
- M_k:第 k 次称量的实际量;
- P_k:第 k 次称量的物料的批次效价;
- t:工单发布时定义的偏差,为千分之几.
- 某一物料(同一阶段,次序,剂量的物料)称量完成判断标准:当 n 次称量后符合图示公式,则代表称量完成.求和公式表示每次物料的实际称量量及批次效价的乘积的总和;M_n\*t 表示第 n 次实际称量量与工单定义偏差的乘积.换算后公式中的负数代表称量总量超出工单发布量,
- 称量终止:![pic](/pics/称量_终止物料.png)
- 称量完成时剩余量不显示,在物料完成称量或工单里的物料均称量完成时,会出现如图所示红色字体提示.

### 4.22 称量进度

- 称量完成百分比:![pic](/pics/称量-称量进度.png)
- 如图所示,标记部分表示某种物料已经完成的称量百分比.假设某物料理论总量为 100kg,理论效价为 80%,实际效价为 50%,则实际待称量量为 160kg;假设第一次实际称量了 50kg,则第二次准备称量时物料与上次称量为同一批次,则理论待称量量为 68.75kg,实际待称量量为 110kg,称量完成百分比为(50÷160)×100%=31.25%.

### 4.23 强制称量

- 如果工单无补偿物料，则可称量物料均可进行强制称量，需签名认证，强制后物料称量状态为"T"（称量完成）;如果工单有效价补偿物料，则效价补偿的原料不可以"强制称量"，无论原料有几种都是，但补偿物料可以强制称量，随时都可以;如果工单有工单补偿物料，则原料和补偿料均可进行强制称量.

### 4.24 容器标签

- 所用容器 ID 的校验:
  - 满足[称量物料复核]章节的要求
  - 该容器的批次在系统中存在,且该批次的物料时当前要称量的物料
  - 该容器中的物料是本次工单称量中可称量的物料
  - 容器没有过期
  - 批次没有过期
  - 超过批次限制使用日期,提示用户是否继续使用
  - FIFO:存在同物料的更早批次(接收日期更早)时,提示用户是否继续使用当前批次;
    - 不继续使用:可换用更早批次
    - 继续使用,则继续称量操作
  - 容器数量不足:容器剩余量<当前待称量量,提示用户是否继续
  - 所用容器的批次库存量不足:批次剩余量<当前待称量量,提示用户是否继续
  - 容器为已结束容器时,提示用户是否继续

### 4.25 称量标签

- 规则:工单(10 位)+版本(2 位,用 0 左补齐)+序号(3 位,用 0 左补齐)
- 在工单称量明细中可以重新打印称量标签

### 4.26 称量数据维护

- 维护同工单统一阶段次序剂量(物料) 的称量次数,按称量完成的操作次数累计:OrderMaterial
- 记录称量结果
- 维护同工单统一阶段次序剂量(物料) 的待称量量:OrderMaterial
- 更新库存(INV)信息: 按物料+批次+库位更新库存量
- 更新所用容器的剩余量:按照容器 ID 更新
- 更新容器所属托盘的满装状态为不满装
- 记录称量的开始时间结束时间:WeighHistory
- 维护称量结果的标签数与容器标签:WeighHistory
  - 标签数:labelQty,同工单的条码个数,也是标签编号,同工单按照打标(重新打标的不计入)个数累计
  - 容器标签:labelCode,标签的条码号
    <!-- ## 5. 称量业务切分
- 待定:称量明细记录切分后无法查看
- 使用 MI 的工单,不在称量工单列表中显示
  - 目前不检查所用 MI 中有没有使用称量节点
  - 只显示已发布/生产中的工单. -->
