# 工单管理

## 1. 工单物料称量单位转换规则:

### 1.1 用途

- 衡器推荐,量程,精度约束

### 1.2 规则

- 在创建/编辑工单物料时,将处方组分的单位,按如下规则转换后,存储在称量单位字段中

| X< Q < Y                   | 称量单位 |
| -------------------------- | -------- |
| Q <10 g                    | mg       |
| 10 g < Q < 10 kg           | g        |
| Q >= 10 kg                 | kg       |
| Q < 10 l                   | ml       |
| Q >= 10 l                  | l        |
| Q < 10 000 iu              | iu       |
| 10 000 iu <= Q < 10 000 ku | ku       |
| 10 000 ku <= Q < 10 000 mu | mu       |
| Q >= 10 000 mu             | gu       |
| Q <= 10 000 un             | un       |
| Q > 10 000 un              | kn       |
| Q < 1 kn                   | un       |
| Q >= 1 kn                  | kn       |
| Q ( fl)                    | fl       |

- 工单上的总体状态：使用批次状态中的`测试,检验,批准,带条件批准`
## 2. 工单生命周期

- ![pic](/pics/工单_生命周期.png)

## 3. 功能说明:

- 明细查看:查看指定工单的明细信息;查看方式如下:
  - 双击指定工单, 以只读方式显示工单明细
  - 指定工单,点击【查看】按钮,以只读方式显示工单明细
  - 在明细界面添加显示处方功能
    - 点击[处方]按钮,显示该工单所用处方的明细
- 创建
  - 校验当前配方是否在有效期内.
  - 工单数量单位是否匹配配方单位.
  - 工单数量是否为数值,默认值为参考数量.
  - 配方工单的物料都是来自所选择配方,并且不能增加,删除物料.
  - 界面说明: #由于业务不同,头部可编辑的字段也不一样.编辑工单能编辑工单数量,注释,修正工单可以编辑注释. 如果是创建工单,请见下图:  
    ![pic](/pics/工单_创建工单头部字段来源.jpg)
  - 关于工单数量单位约束说明:  
    ![pic](/pics/工单_工单数量单位选择约束.png)
  - 列表可修改字段如下:
    - 偏差 称量模式 批次状态 配送称量(Y) 制造称量(Y) 包装称量(Y)
    - 注:只有为 Y 得情况下才可以修改.
  - 工单号: 系统生成,规则为 WO+8 位数字序列,递增,但不要求连续;
  - 批次号:系统自动生成,一个 lot 只能对应一个 WO;规则为:LOT+7 位数字序列,递增,但不要求连续
- 发布
  - 校验是否设置工作中心(最低要有一个工作中心)
  - 发布时间不能小于当前时间(默认为当前时间),必须小于绑定的 PI 有效时间.
  - 检验是否绑定了 MI,并作提示.
  - 优先级默认为 1,范围 1~9
  - 按钮说明:
    - 所选工单如果是创建状态（M）,按钮字段为【发布】,发布后工单状态为 L.
    - 如果工单状态为已发布（L）,按钮字段为【未发布】,撤回到 M 状态.其他致灰色.
- 取消发布
  - 只允许已发布（L）执行此操作.
- 修正
  - 处方工单修正,不能增加非处方内的物料.
  - 头部注释字段可以编辑修改.
  - 按钮说明:需要修正的初始 WO,状态不能是关闭（C）或取消（D）的.
- 编辑
  - 头部只允许修改数量.
  - 列表可修改字段如下:
    - 偏差 称量模式 批次状态 配送称量(Y) 制造称量(Y) 包装称量(Y)
    - 注:只有为 Y 得情况下才可以修改.
- 取消
  - 已取消（D）,已关闭（C）和已归档（A）的工单无法执行此操作.
  - 如果工单跟其他系统(如 ERP)有关联,则不能删除.
  - 执行取消操作后,还会执行其他业务操作:
    - 取消其他相应的任务.
    - 会释放当前工单生产线的设备.
    - 如果 MI 文本正在执行,提示用户,确认后,任务将被中止.
    - 生成追溯信息.
    - 生成 WO 关联事务.
- 终止
  - 只允许已发布（L）,生产中（I）执行此操作.
  - 执行终止按钮时,对工单进行检验,如果当前工单没有执行完最后一次生产操作,提示当前工单没有执行完成生产操作(具体根据 MI 来确定),是否继续终止? 如果继续,状态更改为 T.如果已经执行完最后一次操作,不做提示.
- 关闭
  - 只允许生产终止（T）执行此操作.
  - 如果工单存在生产产出,此种情况下,没有生产声明是不让关闭的.
- 集中
  - 物料集中的生命周期:
    - ![pic](/pics/工单_集中生命周期.png)
  - 只允许生产中（I）开放此按钮.
  - 在 MI 集中模块中规划需要集中的物料,规划规则如下:
    - 指定开始阶段,次序,剂量和结束阶段,次序,剂量.
      - 比喻:从阶段 0001 次序 0001 剂量 1--->阶段 0003 次序 0003 剂量 1.
    - 如果只是指定了阶段 0001--->0002,将集中 0001,0002 阶段的所有序列和剂量.
  - 只能对存在已称量的材料线进行集中操作.
  - 集中的方式可以手动输入容器批次标签码,或者扫描枪扫描.核对确认后,状态会更改为已集中（R）,同时更新称量历史表信息,如果该物料所有容器被集中,更新工单该物料信息
  - 可以选择性的重新打印称量时的容器标签.
  - 如果称量的时候,物料在称量间是有托盘的.那么集中操作可以对在称量间的托盘进行调整.
    - 可以将托盘从称量间释放.
    - 可以添加新的托盘,并生成新的标签.
- 转移
  - 转移功能主要体现在包装阶段,多个工单相同材料线上的物料转移.
  - 转移的物料主要是的包装线上返回多余的物料.
  - 工单状态限制在生产中(I).

## 4.其他相关补偿说明

- 新增物料:![pic](/pics/工单_新增物料.png)
- 修改物料:![pic](/pics/工单_修改物料.png)
- 新增,修改物料页面增加是否固定字段,Y 和 N,为 Y 时候,该物料不参与工单数量的计算.
- 关于纠正工单补偿器字段说明:纠正工单,补偿器字段默认为 N,不可编辑
- 关于添加物料公差字段补充说明:如果称量间称量,车间称量,包装间称量都为 Y,公差取称量间对应的公差.如果只存在一个为 Y,它的公差,如果都为 N,则公差默认为 0.
- 在用处方创建工单时,如果称量间,车间都为 Y,取称量间公差值,如果将称量间改为 N,则取车间公差值
- 如果对工单进行修正操作,添加物料,该物料的信息都是来自物料基础数据.效价一直都带着,是否使用,取决于是否使用效价字段.

## Wo Review

- REVUE_OF_PRESENTE 0/1
- doc Sp-SupervisorStation-c.pdf

## 5.工单筛选

- 使用工单的计划执行路径来筛选工单的显示,路径由工作中心组成
  - 单个工作中心:只有属于该工作中心的工站才能看到该工单
  - 多个工作中心:属于这些工作中心的工站均可能看到该工单
  - 无工作中心:所有工站均可看到该工单
- (暂不实现)工单筛选配置
  - 系统提供配置功能:是否启用工单筛选功能
